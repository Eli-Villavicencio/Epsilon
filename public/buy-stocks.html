<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Comprar Acciones - Portfolio Management</title>
    <script src="./js/header-loader.js"></script>
    <link rel="stylesheet" href="./css/global.css">
    <link rel = "stylesheet" href ="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
    @import url('https://fonts.googleapis.com/css2?family=Teachers:ital,wght@0,400..800;1,400..800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Lexend:wght@100..900&family=Teachers:ital,wght@0,400..800;1,400..800&display=swap');
    @import url('https://fonts.googleapis.com/css2?family=Didact+Gothic&family=Lexend:wght@100..900&family=Teachers:ital,wght@0,400..800;1,400..800&display=swap');
        body { 
            font-family: Arial, sans-serif; 
            margin: 0; 
            padding: 0; 
            background-color: #f5f5f5; 
            color: #293b36;
        }
        
        .main-content {
            max-width: 800px;
            margin: 20px auto;
            padding: 0 20px;
        }
        
        .page-header {
            background: white;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            border-left: 5px solid #53af68;
        }
        
        .page-title {
            margin: 0 0 10px 0;
            font-size: 28px;
            font-weight: 700;
            color: #293b36;
            font-family:"Lexend", sans-serif;
        }
        
        .page-subtitle {
            margin: 0;
            color: #666;
            font-size: 16px;
            font-size:"Didact Gothic", sans-serif;
        }
        
        .container { 
            max-width: 800px; 
            margin: 0 auto; 
        }
        .header { 
            background: rgb(231, 234, 251); 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .header h1{
            font-family: "Lexend", sans-serif;

        }
        .card { 
            background: white; 
            padding: 20px; 
            border-radius: 8px; 
            margin-bottom: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); 
        }
        .card h3{
            font-family:"Lexend", sans-serif;
            color: #5b5c5b;

        
        }
        .cash-info{
            font-family:"Didact Gothic", sans-serif;
        }
        .form-group { 
            margin-bottom: 15px; 
        }
        .form-group label{
            font-family:"Didact Gothic", sans-serif;
            font-size:18px;
            color:#7b7b7b;
        }
        label { 
            display: block; 
            margin-bottom: 5px; 
            color: #555; 
            font-weight: bold; 
        }
        input, select { 
            width: 100%; 
            padding: 10px; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            box-sizing: border-box; 
        }
        button { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            padding: 10px 20px; 
            border-radius: 4px; 
            cursor: pointer; 
            margin-right: 10px; 
            font-weight: 700;
        }
        button:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
        }
        .stock-info { 
            background: #f8f9fa; 
            padding: 15px; 
            border-radius: 4px; 
            margin: 15px 0; 
        }
        .price { 
            font-size: 24px; 
            font-weight: bold; 
            color: #28a745; 
        }
        .change-positive { 
            color: #58b26d; 
        }
        .change-negative { 
            color: rgb(181, 80, 90); 
        }
        .back-btn { 
            background: #9586B1; 
            border-radius:16px;
            font-size:18px;
            font-family:"Teachers", sans-serif;
        }
        .message { 
            padding: 10px; 
            border-radius: 4px; 
            margin: 10px 0; 
        }
        .success { 
            background: #d4edda; 
            color: #155724; 
            border: 1px solid #c3e6cb; 
        }
        .error { 
            background: #f8d7da; 
            color: #721c24; 
            border: 1px solid #f5c6cb; 
        }
        
        /* Nuevo estilo para la b√∫squeda inspirado en stocks.html */
        .search-box {
            position: relative;
            width: 100%;
            margin-bottom: 15px;
            
        }
        .search-box input {
            padding: 12px 50px 12px 15px;
            width: 100%;
            box-sizing: border-box;
            font-size: 16px;
            border-radius:24px;
            background: #e7e5f7;
            font-family:"Didact Gothic", sans-serif;
        }
        .search-box input:focus {
            border-color: #ae00ff;
            outline: none;
            box-shadow: 0 rgb(117, 5, 223) rgba(0, 123, 255, 0.1);
        }
        .search-box button {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            cursor: pointer;
            font-size: 20px;
            color: #666;
            padding: 5px;
            border-radius: 50%;
            transition: all 0.3s;
        }
        .search-box button:hover {
            color: #007bff;
            background: #f8f9fa;
        }
        .search-results {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            display: none;
        }
        .search-results.default-view {
            display: block;
            border: 1px solid #e7f3ff;
            background: #f8fafe;
        }
        .search-results.search-view {
            display: block;
            border: 1px solid #ddd;
            background: white;
        }
        .stock-container {
            padding: 15px;
            border-bottom: 1px solid #232fd6;
            transition: background-color 0.2s;
            position: relative;
        }
        .stock-container:hover {
            background-color: rgb(227, 237, 247);
        }
        .stock-container:last-child {
            border-bottom: none;
        }
        .stock-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }
        .stock-basic-info {
            flex: 1;
        }
        .stock-actions {
            display: flex;
            gap: 8px;
        }
        .stock-action-btn {
            padding: 8px 12px;
            border: 1px solid #4e7eb3;
            background: white;
            color: #4e7eb3;
            border-radius: 10px;
            cursor: pointer;
            font-size: 11px;
            transition: all 0.2s;
            text-decoration: none;
            font-family:"Teachers", sans-serif;
            font-size: 15px;
        }
        .stock-action-btn:hover {
            background: #4e7eb3;
            color: white;
        }
        .stock-action-btn.primary {
            background: #4e7eb3;
            color: white;
        }
        .stock-action-btn.primary:hover {
            background: #4e7eb3;
        }
        .stock-container h3 {
            margin: 0 0 8px 0;
            color: #333;
            font-size: 16px;
        }
        .stock-container .stock-symbol {
            font-weight: bold;
            color: #4e7eb3;
            font-size: 18px;
            margin-bottom: 5px;
            font-family:"Teachers", sans-serif;
        }
        .stock-container .stock-price {
            font-weight: bold;
            font-size: 20px;
            margin-bottom: 3px;
            font-family:"Didact Gothic", sans-serif;
        }
        .stock-container .stock-change {
            font-size: 14px;
            font-family:"Didact Gothic", sans-serif;
        }
        .stock-container .loading-price {
            color: #666;
            font-style: italic;
            font-family:"Didact Gothic", sans-serif;
            font-size:14px;
        }
        .stock-container .error-price {
            color: #dc3545;
            font-size: 12px;
            font-family:"Didact Gothic", sans-serif;
        }
        .search-status {
            text-align: center;
            padding: 20px;
            color: #666;
            font-style: italic;
        }
        .loading-spinner {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #007bff;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .top-stocks-header {
            padding: 15px;
            background: linear-gradient(135deg, rgb(147, 164, 241) 0%,rgb(177, 121, 236)100%);
            color: rgb(75, 74, 74);
            text-align: center;
            font-weight: bold;
            border-radius: 8px 8px 0 0;
            margin: 0;
            font-family:"Lexend", sans-serif;
            font-size:18px;
        }
        .popular-badge {
            display: inline-block;
            background: #28a745;
            color: white;
            font-size: 10px;
            padding: 2px 6px;
            border-radius: 10px;
            margin-left: 8px;
        }
        .market-leader {
            background: linear-gradient(45deg, #ffd700, #ffed4e);
            color: #333;
        }
        .top-gainer {
            background: linear-gradient(45deg, #28a745, #20c997);
            color: white;
        }
        .high-volume {
            background: linear-gradient(45deg, #007bff, #0056b3);
            color: white;
        }
        .logout-btn { 
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%); 
            color: white; 
            font-weight: 700;
            padding: 8px 12px;
            font-size: 12px;
        }
        .logout-btn:hover { 
            background: linear-gradient(135deg, #c82333 0%, #a71e2a 100%);
            transform: translateY(-2px); 
            box-shadow: 0 8px 25px rgba(220,53,69,0.4); 
        }

        /* Message Modal Styles */
        .message-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: 2000;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-backdrop {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
        }

        .modal-container {
            position: relative;
            background: white;
            border-radius: 20px;
            min-width: 400px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            overflow: hidden;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .modal-container.closing {
            animation: modalSlideOut 0.3s ease-in-out;
        }

        @keyframes modalSlideOut {
            from {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
            to {
                opacity: 0;
                transform: scale(0.7) translateY(-50px);
            }
        }

        .modal-header {
            padding: 30px 30px 20px 30px;
            text-align: center;
            border-bottom: 1px solid #eee;
        }

        .modal-header.success {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
            border-bottom: none;
        }

        .modal-header.error {
            background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
            color: white;
            border-bottom: none;
        }

        .modal-header.warning {
            background: linear-gradient(135deg, #ffc107 0%, #fd7e14 100%);
            color: #212529;
            border-bottom: none;
        }

        .modal-icon {
            font-size: 48px;
            margin-bottom: 15px;
            display: block;
            animation: modalIconBounce 0.6s ease-out 0.2s both;
        }

        @keyframes modalIconBounce {
            0% {
                transform: scale(0);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        .modal-title {
            margin: 0;
            font-size: 24px;
            font-weight: bold;
            font-family: "Lexend", sans-serif;
        }

        .modal-body {
            padding: 30px;
        }

        .modal-message {
            font-size: 16px;
            line-height: 1.6;
            text-align: center;
            color: #333;
            margin-bottom: 20px;
            font-family: "Didact Gothic", sans-serif;
        }

        .modal-details {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 12px;
            margin-top: 20px;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #dee2e6;
        }

        .detail-row:last-child {
            border-bottom: none;
        }

        .detail-label {
            color: #666;
            font-weight: 500;
            font-family: "Lexend", sans-serif;
        }

        .detail-value {
            font-weight: bold;
            color: #333;
            font-family: "Didact Gothic", sans-serif;
        }

        .modal-actions {
            padding: 0 30px 30px 30px;
            text-align: center;
        }

        .modal-btn {
            padding: 15px 30px;
            border: none;
            border-radius: 12px;
            font-weight: bold;
            cursor: pointer;
            font-size: 16px;
            font-family: "Lexend", sans-serif;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn-success {
            background: linear-gradient(135deg, #52a766 0%, #60974a 100%);
            color: white;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.2);
        }

        /* Responsive */
        @media (max-width: 480px) {
            .modal-container {
                min-width: auto;
                width: 95%;
                margin: 20px;
            }

            .modal-header, .modal-body, .modal-actions {
                padding: 20px;
            }

            .modal-icon {
                font-size: 36px;
            }

            .modal-title {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="main-content">
        <div class="page-header">
            <h1 class="page-title"> <i class="fa-solid fa-sack-dollar"></i> Buy Stocks</h1>
            <p class="page-subtitle">Search and buy stocks for your portfolio</p>
        </div>

        <div class="container">
            <div class="header">
                <h1>Buy Stocks</h1>
                <div style="display: flex; gap: 15px; align-items: center;">
                    <div class="cash-info">
                        <div style="font-size: 18px; opacity: 0.9; font-weight: 700;">Available Cash</div>
                        <div id="cashBalance" style="font-size: 20px; font-weight: 700;">$0.00</div>
                    </div>
                    <button class="btn btn-success" onclick="showAddCashModal()">Add Money</button>
                    <button class="back-btn" onclick="window.location.href='dashboard.html'">Back to Dashboard</button>
                    <button class="logout-btn" onclick="logout()" title="Sign Out"><i class="fa-solid fa-right-from-bracket"></i>  Exit</button>
                </div>
            </div>

            <div class="card">
                <h3>Search Stock</h3>
                <div class="form-group">
                    <label for="searchInput">Symbol or Company Name:</label>
                    <div class="search-box">
                        <input type="text" id="searchInput" placeholder="e.g: AAPL, Apple, GOOGL, Microsoft...">
                        <button id="searchBtn"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </div>
                </div>
                <div id="searchResults" class="search-results"></div>
            </div>

            <div class="card" id="stockCard" style="display: none;">
                <h3>Stock Information</h3>
                <div id="stockInfo" class="stock-info"></div>
                
                <div class="form-group">
                    <label for="quantity">Number of Shares:</label>
                    <input type="number" id="quantity" min="1" value="1">
                </div>
                
                <div id="totalCost" style="font-size: 18px; font-weight: bold; margin: 15px 0;"></div>
                
                <button onclick="buyStock()">Buy Stocks</button>
                <button onclick="clearSelection()" style="background: #6c757d;">Clear</button>
            </div>
        </div>

    <!-- Add Cash Modal -->
    <div id="addCashModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000;">
        <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 12px; min-width: 300px; box-shadow: 0 20px 40px rgba(0,0,0,0.3);">
            <h3 style="margin-top: 0; color: #293b36; font-family: 'Lexend', sans-serif;">üí∞ Add Money to Account</h3>
            <div class="form-group">
                <label for="cashAmount" style="font-family: 'Lexend', sans-serif;">Amount:</label>
                <input type="number" id="cashAmount" min="1" step="0.01" placeholder="0.00" style="width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 16px;">
            </div>
            <div style="display: flex; gap: 10px; justify-content: flex-end; margin-top: 20px;">
                <button class="btn-secondary" onclick="closeAddCashModal()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700;">Cancel</button>
                <button class="btn-success" onclick="addCash()" style="background: linear-gradient(135deg, #28a745 0%, #20c997 100%); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; font-weight: 700;">Add</button>
            </div>
        </div>
    </div>

    <!-- Success/Error Popup Modal -->
    <div id="messageModal" class="message-modal" style="display: none;">
        <div class="modal-backdrop"></div>
        <div class="modal-container" id="modalContainer">
            <div class="modal-header" id="modalHeader">
                <div class="modal-icon" id="modalIcon">‚úÖ</div>
                <h3 class="modal-title" id="modalTitle">Successful Operation</h3>
            </div>
            <div class="modal-body">
                <div class="modal-message" id="modalMessage">
                    <!-- Message will be inserted here dynamically -->
                </div>
                <div class="modal-details" id="modalDetails" style="display: none;">
                    <!-- Additional details will be shown here -->
                </div>
            </div>
            <div class="modal-actions">
                <button class="modal-btn modal-btn-primary" id="modalOkBtn" onclick="closeMessageModal()">
                    ‚úÖ Understood
                </button>
            </div>
        </div>
    </div>

    <script>
        let selectedStock = null;
        const userId = localStorage.getItem('userId');
        let isLoading = false;
        let searchTimeout;

        if (!userId) {
            window.location.href = 'login.html';
        }

        // Referencias a elementos DOM
        const searchInput = document.getElementById('searchInput');
        const searchBtn = document.getElementById('searchBtn');
        const searchResults = document.getElementById('searchResults');

        // Top 10 acciones populares por defecto
        const topStocks = [
            { symbol: 'AAPL', category: 'market-leader', label: 'üëë L√≠der' },
            { symbol: 'GOOGL', category: 'high-volume', label: 'üìä Alto Volumen' },
            { symbol: 'MSFT', category: 'market-leader', label: 'üëë L√≠der' },
            { symbol: 'AMZN', category: 'high-volume', label: 'üìä Alto Volumen' },
            { symbol: 'TSLA', category: 'top-gainer', label: 'üöÄ Tendencia' },
            { symbol: 'META', category: 'top-gainer', label: 'üöÄ Tendencia' },
            { symbol: 'NVDA', category: 'top-gainer', label: 'üöÄ Tendencia' },
            { symbol: 'JPM', category: 'market-leader', label: 'üè¶ Bancario' },
            { symbol: 'V', category: 'market-leader', label: 'üí≥ Fintech' },
            { symbol: 'JNJ', category: 'market-leader', label: 'üè• Salud' }
        ];

        // Funci√≥n para mostrar el top 10 por defecto
        async function loadTopStocks() {
            searchResults.style.display = 'block';
            searchResults.className = 'search-results default-view';
            
            searchResults.innerHTML = `
                <div class="top-stocks-header">
                     Top 10 Acciones Populares
                </div>
                <div class="search-status">
                    <div class="loading-spinner"></div> Cargando acciones populares...
                </div>
            `;

            try {
                const stocksHTML = [];
                
                for (let i = 0; i < topStocks.length; i++) {
                    const stock = topStocks[i];
                    const container = document.createElement("div");
                    container.className = "stock-container";
                    container.setAttribute('data-symbol', stock.symbol);
                    
                    // Estructura inicial con ranking
                    container.innerHTML = `
                        <div class="stock-header">
                            <div class="stock-basic-info">
                                <div class="stock-symbol">
                                    #${i + 1} ${stock.symbol}
                                    <span class="popular-badge ${stock.category}">${stock.label}</span>
                                </div>
                                <h3>Cargando nombre...</h3>
                            </div>
                            <div class="stock-actions">
                                <a href="stock-details.html?symbol=${stock.symbol}" class="stock-action-btn" target="_blank">
                                    Details
                                </a>
                                <button class="stock-action-btn primary" onclick="selectStockFromSearch('${stock.symbol}')">
                                    Buy
                                </button>
                            </div>
                        </div>
                        <div class="stock-price loading-price">Cargando precio...</div>
                        <div class="stock-change"></div>
                    `;
                    
                    stocksHTML.push(container.outerHTML);
                    
                    // Cargar precio de forma as√≠ncrona
                    setTimeout(() => {
                        const actualContainer = searchResults.querySelector(`[data-symbol="${stock.symbol}"]`);
                        if (actualContainer) {
                            loadTopStockPrice(stock.symbol, actualContainer, i + 1, stock);
                        }
                    }, i * 200); // Stagger loading for better UX
                }
                
                searchResults.innerHTML = `
                    <div class="top-stocks-header">
                        Top 10 popular stocks
                    </div>
                    ${stocksHTML.join('')}
                `;
                
            } catch (err) {
                console.error('Error cargando top stocks:', err);
                searchResults.innerHTML = `
                    <div class="top-stocks-header">
                        Top 10 Acciones Populares
                    </div>
                    <div class="search-status" style="color: #dc3545;">
                        Error cargando acciones populares
                    </div>
                `;
            }
        }

        // Funci√≥n espec√≠fica para cargar precio de top stocks
        async function loadTopStockPrice(symbol, container, rank, stockInfo) {
            try {
                const response = await fetch(`/api/market/stock-price/${symbol}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const changeClass = data.change >= 0 ? 'change-positive' : 'change-negative';
                    const changeSign = data.change >= 0 ? '+' : '';
                    
                    // Update the container with enhanced layout including ranking
                    container.innerHTML = `
                        <div class="stock-header">
                            <div class="stock-basic-info">
                                <div class="stock-symbol">
                                    #${rank} ${data.symbol}
                                </div>
                                <h3>${data.shortName || `${symbol} Company`}</h3>
                            </div>
                            <div class="stock-actions">
                                <a href="stock-details.html?symbol=${symbol}" class="stock-action-btn" target="_blank">
                                     Details
                                </a>
                                <button class="stock-action-btn primary" onclick="selectStockFromSearch('${symbol}')">
                                     Buy
                                </button>
                            </div>
                        </div>
                        <div class="stock-price">$${data.price.toFixed(2)}</div>
                        <div class="stock-change ${changeClass}">
                            ${changeSign}${data.change.toFixed(2)} (${changeSign}${data.changePercent.toFixed(2)}%)
                        </div>
                        ${data.volume ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">Vol: ${data.volume.toLocaleString()}</div>` : ''}
                        <div style="font-size: 11px; color: #999; margin-top: 3px;">
                            Cap. Mercado: ${data.marketCap ? formatMarketCap(data.marketCap) : 'N/A'}
                        </div>
                    `;
                } else {
                    throw new Error('No se pudo obtener el precio');
                }
            } catch (err) {
                console.error(`Error fetching price for ${symbol}:`, err);
                container.innerHTML = `
                    <div class="stock-header">
                        <div class="stock-basic-info">
                            <div class="stock-symbol">
                                #${rank} ${symbol}
                                <span class="popular-badge ${stockInfo.category}">${stockInfo.label}</span>
                            </div>
                            <h3>${symbol} Company</h3>
                        </div>
                        <div class="stock-actions">
                            <a href="stock-details.html?symbol=${symbol}" class="stock-action-btn" target="_blank">
                                 Details
                            </a>
                            <button class="stock-action-btn primary" onclick="selectStockFromSearch('${symbol}')">
                                 Buy
                            </button>
                        </div>
                    </div>
                    <div class="error-price">Error obteniendo precio</div>
                `;
            }
        }

        // Funci√≥n principal de b√∫squeda adaptada
        async function cargarBusquedaStock(valor) {
            console.log(`üîç Frontend search called with: "${valor}"`);
            
            if (!valor || valor.trim().length < 1) {
                // Si no hay b√∫squeda, mostrar top stocks
                console.log('Empty search, loading top stocks');
                loadTopStocks();
                return;
            }

            try {
                searchResults.style.display = 'block';
                searchResults.className = 'search-results search-view';
                searchResults.innerHTML = `
                    <div class="search-status">
                        <div class="loading-spinner"></div> Buscando "${valor}"...
                    </div>
                `;

                console.log(`Making API call to: /api/market/search-stocks?query=${encodeURIComponent(valor)}`);
                
                // Usar la API existente de b√∫squeda
                const response = await fetch(`/api/market/search-stocks?query=${encodeURIComponent(valor)}`);
                const result = await response.json();

                console.log('API Response:', result);

                if (result.success && result.data.length > 0) {
                    console.log(`Found ${result.data.length} results:`, result.data);
                    searchResults.innerHTML = '';
                    
                    // Procesar solo los primeros 8 resultados para mejor rendimiento
                    const stocks = result.data.slice(0, 8);
                    
                    for (const item of stocks) {
                        const container = document.createElement("div");
                        container.className = "stock-container";
                        container.setAttribute('data-symbol', item.symbol);
                        
                        // Estructura inicial sin precio
                        container.innerHTML = `
                            <div class="stock-header">
                                <div class="stock-basic-info">
                                    <div class="stock-symbol">Symbol: ${item.symbol}</div>
                                    <h3>${item.name}</h3>
                                </div>
                                <div class="stock-actions">
                                    <a href="stock-details.html?symbol=${item.symbol}" class="stock-action-btn" target="_blank">
                                    Details
                                    </a>
                                    <button class="stock-action-btn primary" onclick="selectStockFromSearch('${item.symbol}')">
                                         Buy
                                    </button>
                                </div>
                            </div>
                            <div class="stock-price loading-price">Cargando precio...</div>
                            <div class="stock-change"></div>
                        `;
                        
                        searchResults.appendChild(container);
                        
                        // Cargar precio de forma as√≠ncrona
                        loadStockPrice(item.symbol, container);
                    }
                } else {
                    console.log('No results found or API error');
                    searchResults.innerHTML = `
                        <div class="search-status">
                            No se encontraron resultados para "${valor}". 
                            <button onclick="clearSearchAndShowTop()" style="color: #007bff; text-decoration: underline; background: none; border: none; cursor: pointer;">
                                Ver acciones populares
                            </button>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Error en b√∫squeda:', err);
                searchResults.innerHTML = `
                    <div class="search-status" style="color: #dc3545;">
                        Error al buscar. 
                        <button onclick="clearSearchAndShowTop()" style="color: #007bff; text-decoration: underline; background: none; border: none; cursor: pointer;">
                            Ver acciones populares
                        </button>
                    </div>
                `;
            }
        }

        // Funci√≥n para limpiar b√∫squeda y mostrar top
        function clearSearchAndShowTop() {
            searchInput.value = '';
            loadTopStocks();
        }

        // Funci√≥n auxiliar para formatear market cap
        function formatMarketCap(marketCap) {
            if (marketCap >= 1e12) return '$' + (marketCap / 1e12).toFixed(1) + 'T';
            if (marketCap >= 1e9) return '$' + (marketCap / 1e9).toFixed(1) + 'B';
            if (marketCap >= 1e6) return '$' + (marketCap / 1e6).toFixed(1) + 'M';
            return '$' + marketCap.toLocaleString();
        }

        // Funci√≥n para cargar precio individual de cada acci√≥n
        async function loadStockPrice(symbol, container) {
            try {
                const response = await fetch(`/api/market/stock-price/${symbol}`);
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    const changeClass = data.change >= 0 ? 'change-positive' : 'change-negative';
                    const changeSign = data.change >= 0 ? '+' : '';
                    
                    // Update the container with enhanced layout
                    container.innerHTML = `
                        <div class="stock-header">
                            <div class="stock-basic-info">
                                <div class="stock-symbol">Symbol: ${data.symbol}</div>
                                <h3>${data.shortName || `${symbol} Company`}</h3>
                            </div>
                            <div class="stock-actions">
                                <a href="stock-details.html?symbol=${symbol}" class="stock-action-btn" target="_blank">
                                    Details
                                </a>
                                <button class="stock-action-btn primary" onclick="selectStockFromSearch('${symbol}')">
                                     Buy
                                </button>
                            </div>
                        </div>
                        <div class="stock-price">$${data.price.toFixed(2)}</div>
                        <div class="stock-change ${changeClass}">
                            ${changeSign}${data.change.toFixed(2)} (${changeSign}${data.changePercent.toFixed(2)}%)
                        </div>
                        ${data.volume ? `<div style="font-size: 12px; color: #666; margin-top: 5px;">Volumen: ${data.volume.toLocaleString()}</div>` : ''}
                    `;
                } else {
                    throw new Error('No se pudo obtener el precio');
                }
            } catch (err) {
                console.error(`Error fetching price for ${symbol}:`, err);
                container.innerHTML = `
                    <div class="stock-header">
                        <div class="stock-basic-info">
                            <div class="stock-symbol">Symbol: ${symbol}</div>
                            <h3>${symbol} Company</h3>
                        </div>
                        <div class="stock-actions">
                            <a href="stock-details.html?symbol=${symbol}" class="stock-action-btn" target="_blank">
                                 Details
                            </a>
                            <button class="stock-action-btn primary" onclick="selectStockFromSearch('${symbol}')">
                                Buy
                            </button>
                        </div>
                    </div>
                    <div class="error-price">Error obteniendo precio</div>
                `;
            }
        }

        // Funci√≥n para seleccionar una acci√≥n desde los resultados de b√∫squeda
        async function selectStockFromSearch(symbol) {
            try {
                const response = await fetch(`/api/market/stock-price/${symbol}`);
                const result = await response.json();

                if (result.success) {
                    selectedStock = result.data;
                    displayStockInfo();
                    searchResults.style.display = 'none';
                    document.getElementById('stockCard').style.display = 'block';
                    updateTotalCost();
                    
                    // Opcional: actualizar el input con el s√≠mbolo seleccionado
                    searchInput.value = symbol;
                } else {
                    showMessage('Error obteniendo informaci√≥n de la acci√≥n', 'error');
                }
            } catch (error) {
                showMessage('Error obteniendo informaci√≥n de la acci√≥n', 'error');
            }
        }

        // Event listeners adaptados de stocks.js
        searchInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter') {
                const value = searchInput.value.trim();
                if (value) {
                    cargarBusquedaStock(value);
                }
            }
        });

        // B√∫squeda en tiempo real con debounce mejorada
        searchInput.addEventListener('input', (e) => {
            clearTimeout(searchTimeout);
            const value = e.target.value.trim();
            
            if (value.length >= 2) {
                searchTimeout = setTimeout(() => {
                    cargarBusquedaStock(value);
                }, 500); // Esperar 500ms despu√©s de que el usuario deje de escribir
            } else if (value.length === 0) {
                // Mostrar top stocks cuando se limpia la b√∫squeda
                loadTopStocks();
            }
        });

        searchBtn.addEventListener('click', () => {
            const value = searchInput.value.trim();
            if (value) {
                cargarBusquedaStock(value);
            }
        });

        // Funci√≥n para detectar cuando el input pierde el foco
        searchInput.addEventListener('blur', (e) => {
            // Delay para permitir clics en los resultados
            setTimeout(() => {
                if (!searchInput.value.trim()) {
                    // Solo ocultar si no hay b√∫squeda activa
                    // loadTopStocks(); // Mantener visible para mejor UX
                }
            }, 200);
        });

        // Funci√≥n para mostrar resultados cuando el input recibe foco
        searchInput.addEventListener('focus', (e) => {
            if (!searchInput.value.trim()) {
                loadTopStocks();
            } else {
                searchResults.style.display = 'block';
            }
        });

        // Cerrar resultados al hacer clic fuera (mejorado)
        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box') && 
                !e.target.closest('.search-results') && 
                !e.target.closest('.stock-action-btn')) {
                
                // Solo ocultar si hay b√∫squeda activa, mantener top stocks visible
                if (searchInput.value.trim()) {
                    searchResults.style.display = 'none';
                }
            }
        });

        // Funciones existentes adaptadas
        async function loadCashBalance() {
            try {
                const response = await fetch('/api/investments/cash/balance', {
                    headers: { 'x-user-id': userId }
                });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('cashBalance').textContent = `$${parseFloat(result.data.cashBalance).toLocaleString()}`;
                }
            } catch (error) {
                console.error('Error loading cash balance:', error);
            }
        }

        function displayStockInfo() {
            const stockInfo = document.getElementById('stockInfo');
            const changeClass = selectedStock.change >= 0 ? 'change-positive' : 'change-negative';
            const changeSign = selectedStock.change >= 0 ? '+' : '';

            stockInfo.innerHTML = `
                <h4>${selectedStock.shortName} (${selectedStock.symbol})</h4>
                <div class="price">$${selectedStock.price.toFixed(2)}</div>
                <div class="${changeClass}">
                    ${changeSign}${selectedStock.change.toFixed(2)} (${changeSign}${selectedStock.changePercent.toFixed(2)}%)
                </div>
                <div>Volumen: ${selectedStock.volume ? selectedStock.volume.toLocaleString() : 'N/A'}</div>
                ${selectedStock.dataSource ? `<div style="font-size: 12px; color: #666;">Fuente: ${selectedStock.dataSource}</div>` : ''}
            `;
        }

        function updateTotalCost() {
            const quantity = document.getElementById('quantity').value || 0;
            if (selectedStock && quantity > 0) {
                const total = (selectedStock.price * quantity).toFixed(2);
                document.getElementById('totalCost').innerHTML = `Total: $${parseFloat(total).toLocaleString()}`;
            } else {
                document.getElementById('totalCost').innerHTML = '';
            }
        }

        async function buyStock() {
            const quantity = parseInt(document.getElementById('quantity').value);
            
            if (!selectedStock || !quantity || quantity <= 0) {
                showMessagePopup('error', 'Incomplete Data', 'Select a stock and enter a valid quantity');
                return;
            }

            if (isLoading) {
                showMessagePopup('warning', 'Operation in Progress', 'There is already a purchase in progress. Please wait...');
                return;
            }

            isLoading = true;
            const totalCost = selectedStock.price * quantity;
            
            const buyButton = event.target;
            const originalText = buyButton.textContent;
            buyButton.disabled = true;
            buyButton.textContent = 'Buying...';
            
            try {
                const response = await fetch('/api/investments/', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': userId
                    },
                    body: JSON.stringify({
                        symbol: selectedStock.symbol,
                        quantity: quantity
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    // Show success popup with transaction details
                    const transactionDetails = {
                        'Stock Purchased': `${selectedStock.symbol} - ${selectedStock.shortName}`,
                        'Quantity': `${quantity} shares`,
                        'Price per Share': `$${selectedStock.price.toFixed(2)}`,
                        'Total Invested': `$${totalCost.toLocaleString()}`,
                        'New Balance': `$${parseFloat(result.data.remainingCash).toLocaleString()}`
                    };

                    showMessagePopup(
                        'success', 
                        'üéâ Purchase Successful!', 
                        result.message,
                        transactionDetails
                    );
                    
                    // Update header balance
                    if (window.headerLoader) {
                        window.headerLoader.updateCashBalance(result.data.remainingCash);
                    }
                    
                    document.getElementById('cashBalance').textContent = `$${parseFloat(result.data.remainingCash).toLocaleString()}`;
                    
                    setTimeout(() => {
                        clearSelection();
                        loadCashBalance();
                    }, 1000);
                } else {
                    // Show error popup with helpful information
                    let errorDetails = null;
                    
                    if (result.message.includes('money') || result.message.includes('funds') || result.message.includes('balance')) {
                        errorDetails = {
                            'Total Cost': `$${totalCost.toLocaleString()}`,
                            'Current Balance': `$${parseFloat(result.currentBalance || 0).toLocaleString()}`,
                            'Money Needed': `$${(totalCost - parseFloat(result.currentBalance || 0)).toLocaleString()}`,
                            'Suggestion': 'Use the "Add Money" button to deposit funds'
                        };
                    }

                    showMessagePopup(
                        'error',
                        '‚ùå Purchase Error',
                        result.message,
                        errorDetails
                    );
                }
            } catch (error) {
                console.error('Error buying stock:', error);
                showMessagePopup(
                    'error',
                    'üîå Connection Error',
                    'Could not complete the purchase. Check your internet connection and try again.'
                );
            } finally {
                isLoading = false;
                buyButton.disabled = false;
                buyButton.textContent = originalText;
            }
        }

        // New function to show popup messages
        function showMessagePopup(type, title, message, details = null) {
            const modal = document.getElementById('messageModal');
            const modalContainer = document.getElementById('modalContainer');
            const modalHeader = document.getElementById('modalHeader');
            const modalIcon = document.getElementById('modalIcon');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalDetails = document.getElementById('modalDetails');
            const modalOkBtn = document.getElementById('modalOkBtn');

            // Reset classes
            modalHeader.className = 'modal-header';
            modalContainer.className = 'modal-container';

            // Set content based on type
            if (type === 'success') {
                modalHeader.classList.add('success');
                modalIcon.textContent = 'üéâ';
                modalOkBtn.className = 'modal-btn modal-btn-success';
                modalOkBtn.innerHTML = ' Perfect!';
            } else if (type === 'error') {
                modalHeader.classList.add('error');
                modalIcon.textContent = '‚ùå';
                modalOkBtn.className = 'modal-btn modal-btn-primary';
                modalOkBtn.innerHTML = ' Try Again';
            } else if (type === 'warning') {
                modalHeader.classList.add('warning');
                modalIcon.textContent = '‚ö†Ô∏è';
                modalOkBtn.className = 'modal-btn modal-btn-primary';
                modalOkBtn.innerHTML = ' Understood';
            }

            modalTitle.textContent = title;
            modalMessage.innerHTML = message;

            // Show or hide details
            if (details) {
                const detailsHTML = Object.entries(details).map(([label, value]) => `
                    <div class="detail-row">
                        <span class="detail-label">${label}:</span>
                        <span class="detail-value">${value}</span>
                    </div>
                `).join('');
                
                modalDetails.innerHTML = detailsHTML;
                modalDetails.style.display = 'block';
            } else {
                modalDetails.style.display = 'none';
            }

            // Show modal
            modal.style.display = 'flex';
            
            // Add entrance animation
            setTimeout(() => {
                modalContainer.style.animation = 'modalSlideIn 0.4s cubic-bezier(0.34, 1.56, 0.64, 1)';
            }, 10);
        }

        // Function to close popup modal
        function closeMessageModal() {
            const modal = document.getElementById('messageModal');
            const modalContainer = document.getElementById('modalContainer');
            
            modalContainer.classList.add('closing');
            
            setTimeout(() => {
                modal.style.display = 'none';
                modalContainer.classList.remove('closing');
            }, 300);
        }

        // Close modal when clicking on backdrop
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('messageModal');
            const modalBackdrop = e.target.closest('.modal-backdrop');
            
            if (modalBackdrop && modal.style.display === 'flex') {
                closeMessageModal();
            }
        });

        // Close modal with Escape key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('messageModal');
                if (modal.style.display === 'flex') {
                    closeMessageModal();
                }
            }
        });

        // Update the original showMessage function to use popup for important messages
        function showMessage(text, type) {
            // For success and error messages, use popup
            if (type === 'success' || type === 'error') {
                const title = type === 'success' ? ' Successful Operation' : ' Error';
                showMessagePopup(type, title, text);
            } else {
                // For other messages, use the original method
                const messageDiv = document.getElementById('message');
                messageDiv.innerHTML = `<div class="message ${type}">${text}</div>`;
                
                setTimeout(() => {
                    if (messageDiv.innerHTML.includes(text)) {
                        messageDiv.innerHTML = '';
                    }
                }, 8000);
            }
        }

        function clearSelection() {
            selectedStock = null;
            document.getElementById('stockCard').style.display = 'none';
            document.getElementById('searchInput').value = '';
            document.getElementById('quantity').value = '1';
            document.getElementById('searchResults').style.display = 'none';
            document.getElementById('totalCost').innerHTML = '';
        }

        function logout() {
            if (confirm('¬øEst√°s seguro de que quieres cerrar sesi√≥n?')) {
                localStorage.removeItem('userId');
                localStorage.removeItem('user');
                localStorage.removeItem('authToken');
                window.location.href = 'login.html';
            }
        }

        // Check for preselected stock from URL parameters
        function checkPreselectedStock() {
            const urlParams = new URLSearchParams(window.location.search);
            const preselectedSymbol = urlParams.get('symbol');
            
            if (preselectedSymbol) {
                searchInput.value = preselectedSymbol;
                selectStockFromSearch(preselectedSymbol);
            }
        }

        // Funci√≥n para mostrar modal de agregar dinero
        function showAddCashModal() {
            document.getElementById('addCashModal').style.display = 'block';
        }

        // Funci√≥n para cerrar modal de agregar dinero
        function closeAddCashModal() {
            const modal = document.getElementById('addCashModal');
            const cashAmountInput = document.getElementById('cashAmount');
            
            if (modal) {
                modal.style.display = 'none';
            }
            
            if (cashAmountInput) {
                cashAmountInput.value = '';
            }
        }

        // Funci√≥n para agregar dinero
        async function addCash() {
            const cashAmountInput = document.getElementById('cashAmount');
            if (!cashAmountInput) {
                showMessage('Error: elemento de cantidad no encontrado', 'error');
                return;
            }
            
            const amount = parseFloat(cashAmountInput.value);
            
            if (!amount || amount <= 0) {
                showMessage('Ingresa una cantidad v√°lida', 'error');
                return;
            }
            
            try {
                const response = await fetch('/api/investments/cash/add', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'x-user-id': userId
                    },
                    body: JSON.stringify({ amount })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    showMessage(` ${result.message}`, 'Success');
                    
                    // Actualizar balance en la p√°gina
                    document.getElementById('cashBalance').textContent = `$${parseFloat(result.data.newBalance).toLocaleString()}`;
                    
                    closeAddCashModal();
                    
                    // Actualizar balance en el header
                    if (window.headerLoader && window.headerLoader.updateCashBalance) {
                        window.headerLoader.updateCashBalance(result.data.newBalance);
                    }

                    // Refrescar balance despu√©s de un momento
                    setTimeout(() => {
                        loadCashBalance();
                    }, 500);
                } else {
                    showMessage(result.message, 'error');
                }
            } catch (error) {
                console.error('Error adding cash:', error);
                showMessage('Error agregando dinero. Intenta de nuevo.', 'error');
            }
        }

        // Cerrar modal al hacer clic fuera de √©l
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('addCashModal');
            if (e.target === modal) {
                closeAddCashModal();
            }
        });

        // Cerrar modal con tecla Escape
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('addCashModal');
                if (modal.style.display === 'block') {
                    closeAddCashModal();
                }
            }
        });

        // Event listeners
        document.getElementById('quantity').addEventListener('input', updateTotalCost);

        // Load inicial mejorado
        loadCashBalance();
        checkPreselectedStock();
        
        // Mostrar top stocks por defecto al cargar la p√°gina
        setTimeout(() => {
            if (!searchInput.value.trim()) {
                loadTopStocks();
            }
        }, 1000);
    </script>
</body>
</html>
